<!DOCTYPE html>
<html>
<head>
  <title>Homewizard Settings</title>
  <script type="text/javascript" src="/homey.js" data-origin="settings"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      user-select: none;
      border-radius: 6px 6px 0 0;
      margin-right: 4px;
      background: #eee;
    }
    .tab.active {
      background: white;
      border: 1px solid #ccc;
      border-bottom: none;
      font-weight: bold;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .debug-box {
      background: #f3f3f3;
      padding: 15px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-size: 13px;
    }
    th { background: #f0f0f0; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <h1 id="title"></h1>
  <a id="changelog" href="#" target="_blank"></a>
  <a id="support" href="#" target="_blank"></a>
  <br><br>

  <!-- TAB HEADERS -->
  <div class="tabs">
    <div class="tab active" data-tab="baseload" id="tab-baseload"></div>
    <div class="tab" data-tab="fetch">Fetch Debug</div>
    <div class="tab" data-tab="discovery">Discovery Debug</div>
    <div class="tab" data-tab="ws">WebSocket Debug</div>
    <div class="tab" data-tab="legacy">Legacy Fetch</div>
  </div>

  <!-- TAB: BASELOAD -->
  <div id="baseload" class="tab-content active">
    <h2>Sluipverbruik grafiek</h2>
    <canvas id="baseloadChart" height="150"></canvas>

    <h3>Samples van geselecteerde nacht</h3>
    <select id="nightSelector"></select>

    <button id="toggleSamplesBtn" style="
      margin-top: 10px;
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
    ">
      Toon samples
    </button>

    <div id="sampleContainer" style="display:none; margin-top:15px;">
      <table id="sampleTable">
        <thead><tr><th>Tijd</th><th>Vermogen (W)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- TAB: FETCH -->
  <div id="fetch" class="tab-content">
    <h2>FetchQueue debug</h2>
    <pre id="fetch-debug" class="debug-box">Loading…</pre>
  </div>

  <!-- TAB: DISCOVERY -->
  <div id="discovery" class="tab-content">
    <h2>Discovery debug</h2>
    <pre id="discovery-debug" class="debug-box">Loading…</pre>
  </div>

  <!-- TAB: WEBSOCKET -->
  <div id="ws" class="tab-content">
    <h2>WebSocket debug</h2>
    <pre id="ws-debug" class="debug-box">Loading…</pre>
  </div>

  <!-- TAB: LEGACY FETCH -->
  <div id="legacy" class="tab-content">
    <h2>Legacy Fetch debug</h2>
    <pre id="legacyfetch-debug" class="debug-box">Loading…</pre>
  </div>

  <script>
    /* TAB SWITCHING */
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    /* HOMEY READY */
    function onHomeyReady(Homey) {
      document.getElementById('title').innerText = Homey.__('settings.title');
      document.getElementById('changelog').innerText = Homey.__('settings.changelog.label');
      document.getElementById('support').innerText = Homey.__('settings.support.label');
      document.getElementById('support').href = Homey.__('settings.support.link');
      document.getElementById('tab-baseload').innerText = Homey.__('settings.tab_baseload');

      Homey.get(async (err, settings) => {
        if (err) return;

        /* ---- BASELOAD ---- */
        const state = settings['baseload_state'];
        const history = state?.nightHistory || [];

        const labels = history.map(n => n.date);
        const values = history.map(n => n.avg || null);
        const invalid = history.map(n => n.invalid);

        const ctx = document.getElementById('baseloadChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Watt',
              data: values,
              borderColor: 'rgba(0, 150, 255, 1)',
              backgroundColor: 'rgba(0, 150, 255, 0.2)',
              spanGaps: true,
              pointBackgroundColor: invalid.map(v => v ? 'red' : 'green'),
              pointRadius: 5,
            }]
          }
        });

        /* NIGHT SELECTOR */
        const selector = document.getElementById('nightSelector');
        history.forEach((n, i) => {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = `${n.date} ${n.invalid ? '(ongeldig)' : ''}`;
          selector.appendChild(opt);
        });

        selector.addEventListener('change', () => {
          renderSamples(history[selector.value]);
          // samples blijven verborgen tot gebruiker op knop klikt
        });

        function renderSamples(night) {
          const tbody = document.querySelector('#sampleTable tbody');
          tbody.innerHTML = '';
          night.samples.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${new Date(s.ts).toLocaleTimeString()}</td><td>${s.power}</td>`;
            tbody.appendChild(tr);
          });
        }

        const toggleBtn = document.getElementById('toggleSamplesBtn');
        const sampleContainer = document.getElementById('sampleContainer');

        toggleBtn.addEventListener('click', () => {
          const visible = sampleContainer.style.display === 'block';
          sampleContainer.style.display = visible ? 'none' : 'block';
          toggleBtn.textContent = visible ? 'Toon samples' : 'Verberg samples';
        });


        /* ---- FETCH ---- */
        const fetchLog = settings['debug_fetch']?.slice(-20) || [];
        const fetchState = settings['debug_fetch_state'] || {};

        let out = '';
        out += '=== Fetch Log (last 20) ===\n';
        out += JSON.stringify(fetchLog, null, 2);
        out += '\n\n=== Device State ===\n';

        for (const [id, s] of Object.entries(fetchState)) {
          const cooldownActive = Date.now() < s.cooldownUntil;
          const remaining = cooldownActive
            ? Math.round((s.cooldownUntil - Date.now()) / 1000)
            : 0;

          out += `\nDevice: ${id}\n`;
          out += `  Last fetch:   ${s.lastFetch ? new Date(s.lastFetch).toLocaleTimeString() : '—'}\n`;
          out += `  Last error:   ${s.lastErrorAt ? new Date(s.lastErrorAt).toLocaleTimeString() : '—'}\n`;
          out += `  Error count:  ${s.errorCount}\n`;
          out += `  Cooldown:     ${cooldownActive ? `YES (${remaining}s)` : 'no'}\n`;
        }

        document.getElementById('fetch-debug').textContent = out;


        /* ---- DISCOVERY ---- */
        document.getElementById('discovery-debug').textContent =
          JSON.stringify(settings['debug_discovery'] || {}, null, 2);

        /* ---- WEBSOCKET ---- */
        document.getElementById('ws-debug').textContent =
          JSON.stringify(settings['debug_ws']?.slice(-20) || [], null, 2);

        /* ---- LEGACY FETCH ---- */
        document.getElementById('legacyfetch-debug').textContent =
          JSON.stringify(settings['debug_legacy_fetch']?.slice(-50) || [], null, 2);

        Homey.ready();
      });
    }
  </script>

</body>
</html>
